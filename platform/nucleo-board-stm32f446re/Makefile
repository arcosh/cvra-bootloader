################################################################################

PROJNAME = bootloader

# where to place the build files
BUILD_DIR = build

# platform specific source files
PLATFORM_CSRC = platform.c

PROJ_ROOT = ../..
PLATFORM_PATH = platform/nucleo-board-stm32f446re/

include ../verbosity.mk

################################################################################

CC  = arm-none-eabi-gcc
CXX = arm-none-eabi-g++
AS  = arm-none-eabi-gcc -x assembler-with-cpp
LD  = arm-none-eabi-g++
AR  = arm-none-eabi-ar
OC  = arm-none-eabi-objcopy
OD  = arm-none-eabi-objdump
NM  = arm-none-eabi-nm
SZ  = arm-none-eabi-size

MKDIR = mkdir -p

################################################################################

# Generated byte packager from template include.jinja
include include.mk

CSRC     += $(addprefix $(PLATFORM_PATH), $(PLATFORM_CSRC))

# Includes
INCDIR   := ./
INCDIR   += $(PROJ_ROOT)/
INCDIR   += $(PROJ_ROOT)/platform/mcu/armv7-m
INCDIR   += $(PROJ_ROOT)/platform/mcu/stm32f4
INCDIR   += $(PROJ_ROOT)/libopencm3/include
INCDIR   += $(addprefix $(PROJ_ROOT)/, $(PACKAGER_INCDIR))

LDSCRIPT = ./linkerscript.ld

# Target processor
CFLAGS += -mthumb -march=armv7e-m -mtune=cortex-m4 -mfloat-abi=hard -mfpu=fpv4-sp-d16
LFLAGS += -mthumb -march=armv7e-m -mtune=cortex-m4 -mfloat-abi=hard -mfpu=fpv4-sp-d16

DEFINES += -DSTM32F4
OPTIMIZATION = -Og
DEBUGGING = -g
WARNINGS = -Wall -Wextra -Wno-unused-parameter

# C & C++ compiler flags
#CFLAGS   += -fno-common
#CFLAGS   += -ffunction-sections
#CFLAGS   += -fdata-sections
#CFLAGS   += -fno-exceptions
#CFLAGS   += -fomit-frame-pointer
CFLAGS   += $(OPTIMIZATION)
CFLAGS   += $(WARNINGS)
CFLAGS   += $(DEBUGGING)
CFLAGS   += $(DEFINES)
# Create header inclusion dependency files (*.d)
CFLAGS   += -MD
CFLAGS   += $(addprefix  -I, $(INCDIR))

# C only flags
CCFLAGS += -std=gnu99
#CCFLAGS  += -Wstrict-prototypes

# C++ only flags
#CXXFLAGS += -fno-rtti
#CXXFLAGS += -fno-exceptions
#CXXFLAGS += -fno-unwind-tables
#CXXFLAGS += -fno-use-cxa-atexit

# Libraries to link with
LIBOPENCM3 = opencm3_stm32f4
LIBOPENCM3_PATH = $(PROJ_ROOT)/libopencm3
LIBOPENCM3_LD = $(LIBOPENCM3_PATH)/lib/lib$(LIBOPENCM3).ld

LIBS     += -Wl,-lc -Wl,-lgcc -Wl,-lnosys
LIBS     += -Wl,-L$(LIBOPENCM3_PATH)/lib
LIBS     += -Wl,-l$(LIBOPENCM3)

# Linker flags
LFLAGS   += -nostartfiles
LFLAGS   += $(LIBS)
LFLAGS   += -Wl,-Map=$(PROJNAME).map
LFLAGS   += -T$(LDSCRIPT)
LFLAGS   += $(OPTIMIZATION)

CCFLAGS  += $(CFLAGS)
CXXFLAGS += $(CFLAGS)
ASMFLAGS += $(CFLAGS)

COBJS = $(addprefix $(BUILD_DIR)/, $(CSRC:.c=.o))
ASMOBJS = $(addprefix $(BUILD_DIR)/, $(ASMSRC:.s=.o))
CXXOBJS = $(addprefix $(BUILD_DIR)/, $(CXXSRC:.cpp=.o))

OBJS = $(COBJS) $(ASMOBJS) $(CXXOBJS)

#
# targets:
################################################################################

-include ../targets.mk
-include ../openocd.mk
